--x New file group 
--x temp and final tables in file group - DW.[FDS_DAILY_CONFIG_AGGREGATE_FTBL]
--X trunacte temp tables
--X look at files sizes for inital build
--X load final table from combined temp
--x test initial create time (6808083 rows) - this versus new fg in FDS, VS. GROUP PARTITION BY 
-- test merge versus upsert for -200 days 
--   http://www.sqlservercentral.com/articles/MERGE/103127/
--   http://www.databasejournal.com/features/mssql/tempdb-space-usage-in-sql-server.html
--?? test dynamic incremental using [DW].[FDS_MAIN_ETL_DATE_RANGE] and [DW].[FDS_SUBSYS_INCREMENTAL_TRACKER]
USE [FDS]
GO


--TRUNCATE TABLE FDS.DW.FDS_DAILY_CONFIG_AGGREGATE_FTBL


TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_MR
TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C01
TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C02
TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C03
TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C04
TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C05
TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_ALL

DECLARE @FIRST_DT DATETIME = 
		DATEADD(D,-200,CAST(GETDATE() AS DATE))
--CAST(1 AS DATETIME) /* set to CAST(1 AS DATETIME) for all time) */
--IIF((DATEPART(WEEKDAY,GETDATE()) = 7 OR DATEPART(DAY,GETDATE()) = 28) AND DATEPART(HOUR,GETDATE()) < 6
--	, DATEADD(D,-60,CAST(GETDATE() AS DATE))
--	, DATEADD(D,-60,CAST(GETDATE() AS DATE)))

DECLARE @T0 DATETIME = GETDATE()

INSERT INTO FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_MR
SELECT C1MR.SERIAL_NUMBER, C1MR.DATA_SET_DATE_DID
	, MAX_DSDS = MAX(C1MR.DATA_SET_DATE)
	, REP_CNT = COUNT(C1MR.DATA_SET_DATE)
FROM FDS.DW.FDS_CONFIGS_TRX_01_FTBL C1MR
WHERE C1MR.DATA_SET_DATE > @FIRST_DT
GROUP BY C1MR.SERIAL_NUMBER, C1MR.DATA_SET_DATE_DID

DECLARE @T1MR DATETIME = GETDATE()

INSERT INTO FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C01
SELECT DISTINCT C1.SERIAL_NUMBER, C1.DATA_SET_DATE_DID
	, C_130_AVG = AVG(C1.C_130) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_132_AVG = AVG(C1.C_132) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_135_AVG = AVG(C1.C_135) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_165_AVG = AVG(C1.C_165) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_166_AVG = AVG(C1.C_166) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_536_FIRST = FIRST_VALUE(C1.C_536) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID ORDER BY DATA_SET_DATE ASC)
	, C_554_AVG = AVG(C1.C_554) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_636_FIRST = FIRST_VALUE(C1.C_636) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID ORDER BY DATA_SET_DATE ASC)
	, C_751_AVG = AVG(C1.C_751) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
FROM FDS.DW.FDS_CONFIGS_TRX_01_FTBL C1
WHERE C1.DATA_SET_DATE > @FIRST_DT

DECLARE @T1 DATETIME = GETDATE()

INSERT INTO FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C02
SELECT DISTINCT C2.SERIAL_NUMBER, C2.DATA_SET_DATE_DID
	, C_35_AVG = AVG(C2.C_35) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_90_FIRST = FIRST_VALUE(C2.C_90) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID ORDER BY DATA_SET_DATE ASC)
	, C_92_AVG = AVG(C2.C_92) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_131_AVG = AVG(C2.C_131) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_202_MAX = MAX(C2.C_202) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_219_MAX = MAX(C2.C_219) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_245_MAX = MAX(C2.C_245) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_250_AVG = AVG(C2.C_250) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_251_AVG = AVG(C2.C_251) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_409_AVG = AVG(C2.C_409) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_416_AVG = AVG(C2.C_416) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_481_FIRST = FIRST_VALUE(C2.C_481) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID ORDER BY DATA_SET_DATE ASC)
FROM FDS.DW.FDS_CONFIGS_TRX_02_FTBL C2
WHERE C2.DATA_SET_DATE > @FIRST_DT

DECLARE @T2 DATETIME = GETDATE()

INSERT INTO FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C03
SELECT DISTINCT C3.SERIAL_NUMBER, C3.DATA_SET_DATE_DID
	, C_11_AVG = AVG(C3.C_11) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_63_FIRST = FIRST_VALUE(C3.C_63) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID ORDER BY DATA_SET_DATE ASC)
	, C_64_AVG = AVG(C3.C_64) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_65_FIRST = FIRST_VALUE(C3.C_65) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID ORDER BY DATA_SET_DATE ASC)
	, C_67_FIRST = FIRST_VALUE(C3.C_67) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID ORDER BY DATA_SET_DATE ASC)
	, C_122_FIRST = FIRST_VALUE(C3.C_122) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID ORDER BY DATA_SET_DATE ASC)
	, C_126_AVG = AVG(C3.C_126) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_149_AVG = AVG(C3.C_149) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_353_AVG = AVG(C3.C_353) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_354_AVG = AVG(C3.C_354) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_397_AVG = AVG(C3.C_397) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_406_AVG = AVG(C3.C_406) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_407_FIRST = FIRST_VALUE(C3.C_407) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID ORDER BY DATA_SET_DATE ASC)
	, C_625_AVG = AVG(C3.C_625) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_630_AVG = AVG(C3.C_630) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_631_AVG = AVG(C3.C_631) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_632_AVG = AVG(C3.C_632) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_635_AVG = AVG(C3.C_635) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_665_AVG = AVG(C3.C_665) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_666_AVG = AVG(C3.C_666) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_702_MAX = MAX(C3.C_702) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_745_MAX = MAX(C3.C_745) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_808_AVG = AVG(C3.C_808) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_809_AVG = AVG(C3.C_809) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_812_AVG = AVG(C3.C_812) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_813_AVG = AVG(C3.C_813) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_897_AVG = AVG(C3.C_897) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_909_AVG = AVG(C3.C_909) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_916_AVG = AVG(C3.C_916) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_981_FIRST = FIRST_VALUE(C3.C_981) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID ORDER BY DATA_SET_DATE ASC)
FROM FDS.DW.FDS_CONFIGS_TRX_03_FTBL C3
WHERE C3.DATA_SET_DATE > @FIRST_DT

DECLARE @T3 DATETIME = GETDATE() 

INSERT INTO FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C04
SELECT DISTINCT C4.SERIAL_NUMBER, C4.DATA_SET_DATE_DID
	, C_826_AVG = AVG(C4.C_826) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_836_AVG = AVG(C4.C_836) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_838_AVG = AVG(C4.C_838) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_857_FIRST = FIRST_VALUE(C4.C_857) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID ORDER BY DATA_SET_DATE ASC)
	, C_858_AVG = AVG(C4.C_858) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_859_AVG = AVG(C4.C_859) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
FROM FDS.DW.FDS_CONFIGS_TRX_04_FTBL C4
WHERE C4.DATA_SET_DATE > @FIRST_DT

DECLARE @T4 DATETIME = GETDATE() 

INSERT INTO FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C05
SELECT DISTINCT C5.SERIAL_NUMBER, C5.DATA_SET_DATE_DID
	, C_964_FIRST = FIRST_VALUE(C5.C_964) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID ORDER BY DATA_SET_DATE ASC)
	, C_965_AVG = AVG(C5.C_965) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_966_AVG = AVG(C5.C_966) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
	, C_969_AVG = AVG(C5.C_969) OVER (PARTITION BY SERIAL_NUMBER,DATA_SET_DATE_DID)
FROM FDS.DW.FDS_CONFIGS_TRX_05_FTBL C5
WHERE C5.DATA_SET_DATE > @FIRST_DT

DECLARE @T5 DATETIME = GETDATE()  

INSERT INTO FDS.[dbo].[tmp_DAILY_CONFIG_AGGREGATE_ALL]
SELECT _C1MR.SERIAL_NUMBER, _C1MR.DATA_SET_DATE_DID, DATECODE = DT.DATE_DTM, _C1MR.MAX_DSDS, _C1MR.REP_CNT
	, _C1.C_130_AVG, _C1.C_132_AVG, _C1.C_135_AVG, _C1.C_165_AVG, _C1.C_166_AVG
	, _C1.C_536_FIRST, _C1.C_554_AVG, _C1.C_636_FIRST, _C1.C_751_AVG
	, _C2.C_35_AVG, _C2.C_90_FIRST, _C2.C_92_AVG, _C2.C_131_AVG, _C2.C_202_MAX, _C2.C_219_MAX, _C2.C_245_MAX
	, _C2.C_250_AVG, _C2.C_251_AVG, _C2.C_409_AVG, _C2.C_416_AVG, _C2.C_481_FIRST
	, _C3.C_11_AVG, _C3.C_63_FIRST, _C3.C_64_AVG, _C3.C_65_FIRST, _C3.C_67_FIRST, _C3.C_122_FIRST
	, _C3.C_126_AVG, _C3.C_149_AVG, _C3.C_353_AVG, _C3.C_354_AVG, _C3.C_397_AVG, _C3.C_406_AVG, _C3.C_407_FIRST, _C3.C_625_AVG
	, _C3.C_630_AVG, _C3.C_631_AVG, _C3.C_632_AVG, _C3.C_635_AVG, _C3.C_665_AVG, _C3.C_666_AVG, _C3.C_702_MAX, _C3.C_745_MAX
	, _C3.C_808_AVG, _C3.C_809_AVG, _C3.C_812_AVG, _C3.C_813_AVG, _C3.C_897_AVG, _C3.C_909_AVG, _C3.C_916_AVG, _C3.C_981_FIRST
	, _C4.C_826_AVG, _C4.C_836_AVG, _C4.C_838_AVG, _C4.C_857_FIRST, _C4.C_858_AVG, _C4.C_859_AVG
	, _C5.C_964_FIRST, _C5.C_965_AVG, _C5.C_966_AVG, _C5.C_969_AVG
	, LAST_UPDATED_DT = GETDATE()
FROM FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_MR _C1MR
		JOIN FDS.DW.FDS_DATE_DTBL DT ON _C1MR.DATA_SET_DATE_DID = DT.DATE_DID
		LEFT OUTER JOIN FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C01 _C1 ON _C1MR.SERIAL_NUMBER = _C1.SERIAL_NUMBER AND _C1MR.DATA_SET_DATE_DID = _C1.DATA_SET_DATE_DID
		LEFT OUTER JOIN FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C02 _C2 ON _C1MR.SERIAL_NUMBER = _C2.SERIAL_NUMBER AND _C1MR.DATA_SET_DATE_DID = _C2.DATA_SET_DATE_DID
		LEFT OUTER JOIN FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C03 _C3 ON _C1MR.SERIAL_NUMBER = _C3.SERIAL_NUMBER AND _C1MR.DATA_SET_DATE_DID = _C3.DATA_SET_DATE_DID
		LEFT OUTER JOIN FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C04 _C4 ON _C1MR.SERIAL_NUMBER = _C4.SERIAL_NUMBER AND _C1MR.DATA_SET_DATE_DID = _C4.DATA_SET_DATE_DID
		LEFT OUTER JOIN FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C05 _C5 ON _C1MR.SERIAL_NUMBER = _C5.SERIAL_NUMBER AND _C1MR.DATA_SET_DATE_DID = _C5.DATA_SET_DATE_DID

DECLARE @TC DATETIME = GETDATE() 

/*
SETUP TEST FOR UPDATES:
-----------------------
DELETE FROM FDS.DW.FDS_DAILY_CONFIG_AGGREGATE_FTBL
WHERE DATECODE > GETDATE() - 200 AND DATEPART(DAY,DATECODE) = 12 -- 9425

UPDATE FDS.DW.FDS_DAILY_CONFIG_AGGREGATE_FTBL
SET REP_CNT = REP_CNT - 100
WHERE DATECODE > GETDATE() - 200 AND DATEPART(DAY,DATECODE) = 13 -- 9479
*/

DECLARE @SUMMARYOFCHANGES TABLE (CHANGE VARCHAR(20))
/*
MERGE FDS.DW.FDS_DAILY_CONFIG_AGGREGATE_FTBL TRG
USING FDS.DBO.TMP_DAILY_CONFIG_AGGREGATE_ALL SRC
	ON TRG.SERIAL_NUMBER = SRC.SERIAL_NUMBER 
	AND TRG.DATECODE = SRC.DATECODE
WHEN MATCHED AND ISNULL(TRG.REP_CNT,0) <> ISNULL(SRC.REP_CNT,0) THEN
	UPDATE SET 
		TRG.MAX_DSDS = SRC.MAX_DSDS
		, TRG.REP_CNT = SRC.REP_CNT
		, TRG.C_11_AVG = SRC.C_11_AVG, TRG.C_122_FIRST = SRC.C_122_FIRST, TRG.C_126_AVG = SRC.C_126_AVG
		, TRG.C_130_AVG = SRC.C_130_AVG, TRG.C_131_AVG = SRC.C_131_AVG, TRG.C_132_AVG = SRC.C_132_AVG
		, TRG.C_135_AVG = SRC.C_135_AVG, TRG.C_149_AVG = SRC.C_149_AVG, TRG.C_165_AVG = SRC.C_165_AVG
		, TRG.C_166_AVG = SRC.C_166_AVG, TRG.C_202_MAX = SRC.C_202_MAX, TRG.C_219_MAX = SRC.C_219_MAX
		, TRG.C_245_MAX = SRC.C_245_MAX, TRG.C_250_AVG = SRC.C_250_AVG, TRG.C_251_AVG = SRC.C_251_AVG
		, TRG.C_35_AVG = SRC.C_35_AVG, TRG.C_353_AVG = SRC.C_353_AVG, TRG.C_354_AVG = SRC.C_354_AVG
		, TRG.C_397_AVG = SRC.C_397_AVG, TRG.C_406_AVG = SRC.C_406_AVG, TRG.C_407_FIRST = SRC.C_407_FIRST
		, TRG.C_409_AVG = SRC.C_409_AVG, TRG.C_416_AVG = SRC.C_416_AVG, TRG.C_481_FIRST = SRC.C_481_FIRST
		, TRG.C_536_FIRST = SRC.C_536_FIRST, TRG.C_554_AVG = SRC.C_554_AVG, TRG.C_625_AVG = SRC.C_625_AVG
		, TRG.C_63_FIRST = SRC.C_63_FIRST, TRG.C_630_AVG = SRC.C_630_AVG, TRG.C_631_AVG = SRC.C_631_AVG
		, TRG.C_632_AVG = SRC.C_632_AVG, TRG.C_635_AVG = SRC.C_635_AVG, TRG.C_636_FIRST = SRC.C_636_FIRST
		, TRG.C_64_AVG = SRC.C_64_AVG, TRG.C_65_FIRST = SRC.C_65_FIRST, TRG.C_665_AVG = SRC.C_665_AVG
		, TRG.C_666_AVG = SRC.C_666_AVG, TRG.C_67_FIRST = SRC.C_67_FIRST, TRG.C_702_MAX = SRC.C_702_MAX
		, TRG.C_745_MAX = SRC.C_745_MAX, TRG.C_751_AVG = SRC.C_751_AVG, TRG.C_808_AVG = SRC.C_808_AVG
		, TRG.C_809_AVG = SRC.C_809_AVG, TRG.C_812_AVG = SRC.C_812_AVG, TRG.C_813_AVG = SRC.C_813_AVG
		, TRG.C_826_AVG = SRC.C_826_AVG, TRG.C_836_AVG = SRC.C_836_AVG, TRG.C_838_AVG = SRC.C_838_AVG
		, TRG.C_857_FIRST = SRC.C_857_FIRST, TRG.C_858_AVG = SRC.C_858_AVG, TRG.C_859_AVG = SRC.C_859_AVG
		, TRG.C_897_AVG = SRC.C_897_AVG, TRG.C_90_FIRST = SRC.C_90_FIRST, TRG.C_909_AVG = SRC.C_909_AVG
		, TRG.C_916_AVG = SRC.C_916_AVG, TRG.C_92_AVG = SRC.C_92_AVG, TRG.C_964_FIRST = SRC.C_964_FIRST
		, TRG.C_965_AVG = SRC.C_965_AVG, TRG.C_966_AVG = SRC.C_966_AVG, TRG.C_969_AVG = SRC.C_969_AVG
		, TRG.C_981_FIRST = SRC.C_981_FIRST
		, TRG.LAST_UPDATED_DT = GETDATE()
WHEN NOT MATCHED THEN 
	INSERT (SERIAL_NUMBER, DATA_SET_DATE_DID, DATECODE, MAX_DSDS, REP_CNT
			, C_130_AVG, C_132_AVG, C_135_AVG, C_165_AVG, C_166_AVG, C_536_FIRST, C_554_AVG
			, C_636_FIRST, C_751_AVG, C_35_AVG, C_90_FIRST, C_92_AVG, C_131_AVG, C_202_MAX
			, C_219_MAX, C_245_MAX, C_250_AVG, C_251_AVG, C_409_AVG, C_416_AVG, C_481_FIRST
			, C_11_AVG, C_63_FIRST, C_64_AVG, C_65_FIRST, C_67_FIRST, C_122_FIRST, C_126_AVG
			, C_149_AVG, C_353_AVG, C_354_AVG, C_397_AVG, C_406_AVG, C_407_FIRST, C_625_AVG
			, C_630_AVG, C_631_AVG, C_632_AVG, C_635_AVG, C_665_AVG, C_666_AVG, C_702_MAX
			, C_745_MAX, C_808_AVG, C_809_AVG, C_812_AVG, C_813_AVG, C_897_AVG, C_909_AVG
			, C_916_AVG, C_981_FIRST, C_826_AVG, C_836_AVG, C_838_AVG, C_857_FIRST, C_858_AVG
			, C_859_AVG, C_964_FIRST, C_965_AVG, C_966_AVG, C_969_AVG, LAST_UPDATED_DT)
	VALUES (SERIAL_NUMBER, DATA_SET_DATE_DID, DATECODE, MAX_DSDS, REP_CNT
			, C_130_AVG, C_132_AVG, C_135_AVG, C_165_AVG, C_166_AVG, C_536_FIRST, C_554_AVG
			, C_636_FIRST, C_751_AVG, C_35_AVG, C_90_FIRST, C_92_AVG, C_131_AVG, C_202_MAX
			, C_219_MAX, C_245_MAX, C_250_AVG, C_251_AVG, C_409_AVG, C_416_AVG, C_481_FIRST
			, C_11_AVG, C_63_FIRST, C_64_AVG, C_65_FIRST, C_67_FIRST, C_122_FIRST, C_126_AVG
			, C_149_AVG, C_353_AVG, C_354_AVG, C_397_AVG, C_406_AVG, C_407_FIRST, C_625_AVG
			, C_630_AVG, C_631_AVG, C_632_AVG, C_635_AVG, C_665_AVG, C_666_AVG, C_702_MAX
			, C_745_MAX, C_808_AVG, C_809_AVG, C_812_AVG, C_813_AVG, C_897_AVG, C_909_AVG
			, C_916_AVG, C_981_FIRST, C_826_AVG, C_836_AVG, C_838_AVG, C_857_FIRST, C_858_AVG
			, C_859_AVG, C_964_FIRST, C_965_AVG, C_966_AVG, C_969_AVG, GETDATE())
OUTPUT $ACTION INTO @SUMMARYOFCHANGES;
*/
/*
BEGIN TRANSACTION T1; 
UPDATE FDS.DW.FDS_DAILY_CONFIG_AGGREGATE_FTBL
    SET MAX_DSDS = SRC.MAX_DSDS
		, REP_CNT = SRC.REP_CNT
		, C_11_AVG = SRC.C_11_AVG, C_122_FIRST = SRC.C_122_FIRST, C_126_AVG = SRC.C_126_AVG
		, C_130_AVG = SRC.C_130_AVG, C_131_AVG = SRC.C_131_AVG, C_132_AVG = SRC.C_132_AVG
		, C_135_AVG = SRC.C_135_AVG, C_149_AVG = SRC.C_149_AVG, C_165_AVG = SRC.C_165_AVG
		, C_166_AVG = SRC.C_166_AVG, C_202_MAX = SRC.C_202_MAX, C_219_MAX = SRC.C_219_MAX
		, C_245_MAX = SRC.C_245_MAX, C_250_AVG = SRC.C_250_AVG, C_251_AVG = SRC.C_251_AVG
		, C_35_AVG = SRC.C_35_AVG, C_353_AVG = SRC.C_353_AVG, C_354_AVG = SRC.C_354_AVG
		, C_397_AVG = SRC.C_397_AVG, C_406_AVG = SRC.C_406_AVG, C_407_FIRST = SRC.C_407_FIRST
		, C_409_AVG = SRC.C_409_AVG, C_416_AVG = SRC.C_416_AVG, C_481_FIRST = SRC.C_481_FIRST
		, C_536_FIRST = SRC.C_536_FIRST, C_554_AVG = SRC.C_554_AVG, C_625_AVG = SRC.C_625_AVG
		, C_63_FIRST = SRC.C_63_FIRST, C_630_AVG = SRC.C_630_AVG, C_631_AVG = SRC.C_631_AVG
		, C_632_AVG = SRC.C_632_AVG, C_635_AVG = SRC.C_635_AVG, C_636_FIRST = SRC.C_636_FIRST
		, C_64_AVG = SRC.C_64_AVG, C_65_FIRST = SRC.C_65_FIRST, C_665_AVG = SRC.C_665_AVG
		, C_666_AVG = SRC.C_666_AVG, C_67_FIRST = SRC.C_67_FIRST, C_702_MAX = SRC.C_702_MAX
		, C_745_MAX = SRC.C_745_MAX, C_751_AVG = SRC.C_751_AVG, C_808_AVG = SRC.C_808_AVG
		, C_809_AVG = SRC.C_809_AVG, C_812_AVG = SRC.C_812_AVG, C_813_AVG = SRC.C_813_AVG
		, C_826_AVG = SRC.C_826_AVG, C_836_AVG = SRC.C_836_AVG, C_838_AVG = SRC.C_838_AVG
		, C_857_FIRST = SRC.C_857_FIRST, C_858_AVG = SRC.C_858_AVG, C_859_AVG = SRC.C_859_AVG
		, C_897_AVG = SRC.C_897_AVG, C_90_FIRST = SRC.C_90_FIRST, C_909_AVG = SRC.C_909_AVG
		, C_916_AVG = SRC.C_916_AVG, C_92_AVG = SRC.C_92_AVG, C_964_FIRST = SRC.C_964_FIRST
		, C_965_AVG = SRC.C_965_AVG, C_966_AVG = SRC.C_966_AVG, C_969_AVG = SRC.C_969_AVG
		, C_981_FIRST = SRC.C_981_FIRST
		, LAST_UPDATED_DT = GETDATE()
OUTPUT 'UPDATE' INTO @SUMMARYOFCHANGES
FROM FDS.DW.FDS_DAILY_CONFIG_AGGREGATE_FTBL TRG
    JOIN FDS.DBO.TMP_DAILY_CONFIG_AGGREGATE_ALL SRC
		ON TRG.SERIAL_NUMBER = SRC.SERIAL_NUMBER 
			AND TRG.DATECODE = SRC.DATECODE
WHERE ISNULL(TRG.REP_CNT,0) <> ISNULL(SRC.REP_CNT,0);

INSERT INTO FDS.DW.FDS_DAILY_CONFIG_AGGREGATE_FTBL
	(SERIAL_NUMBER, DATA_SET_DATE_DID, DATECODE, MAX_DSDS, REP_CNT
	, C_130_AVG, C_132_AVG, C_135_AVG, C_165_AVG, C_166_AVG, C_536_FIRST, C_554_AVG
	, C_636_FIRST, C_751_AVG, C_35_AVG, C_90_FIRST, C_92_AVG, C_131_AVG, C_202_MAX
	, C_219_MAX, C_245_MAX, C_250_AVG, C_251_AVG, C_409_AVG, C_416_AVG, C_481_FIRST
	, C_11_AVG, C_63_FIRST, C_64_AVG, C_65_FIRST, C_67_FIRST, C_122_FIRST, C_126_AVG
	, C_149_AVG, C_353_AVG, C_354_AVG, C_397_AVG, C_406_AVG, C_407_FIRST, C_625_AVG
	, C_630_AVG, C_631_AVG, C_632_AVG, C_635_AVG, C_665_AVG, C_666_AVG, C_702_MAX
	, C_745_MAX, C_808_AVG, C_809_AVG, C_812_AVG, C_813_AVG, C_897_AVG, C_909_AVG
	, C_916_AVG, C_981_FIRST, C_826_AVG, C_836_AVG, C_838_AVG, C_857_FIRST, C_858_AVG
	, C_859_AVG, C_964_FIRST, C_965_AVG, C_966_AVG, C_969_AVG, LAST_UPDATED_DT)
OUTPUT 'INSERT' INTO @SUMMARYOFCHANGES
SELECT SRC.SERIAL_NUMBER, SRC.DATA_SET_DATE_DID, SRC.DATECODE, SRC.MAX_DSDS, SRC.REP_CNT
	, SRC.C_130_AVG, SRC.C_132_AVG, SRC.C_135_AVG, SRC.C_165_AVG, SRC.C_166_AVG, SRC.C_536_FIRST, SRC.C_554_AVG
	, SRC.C_636_FIRST, SRC.C_751_AVG, SRC.C_35_AVG, SRC.C_90_FIRST, SRC.C_92_AVG, SRC.C_131_AVG, SRC.C_202_MAX
	, SRC.C_219_MAX, SRC.C_245_MAX, SRC.C_250_AVG, SRC.C_251_AVG, SRC.C_409_AVG, SRC.C_416_AVG, SRC.C_481_FIRST
	, SRC.C_11_AVG, SRC.C_63_FIRST, SRC.C_64_AVG, SRC.C_65_FIRST, SRC.C_67_FIRST, SRC.C_122_FIRST, SRC.C_126_AVG
	, SRC.C_149_AVG, SRC.C_353_AVG, SRC.C_354_AVG, SRC.C_397_AVG, SRC.C_406_AVG, SRC.C_407_FIRST, SRC.C_625_AVG
	, SRC.C_630_AVG, SRC.C_631_AVG, SRC.C_632_AVG, SRC.C_635_AVG, SRC.C_665_AVG, SRC.C_666_AVG, SRC.C_702_MAX
	, SRC.C_745_MAX, SRC.C_808_AVG, SRC.C_809_AVG, SRC.C_812_AVG, SRC.C_813_AVG, SRC.C_897_AVG, SRC.C_909_AVG
	, SRC.C_916_AVG, SRC.C_981_FIRST, SRC.C_826_AVG, SRC.C_836_AVG, SRC.C_838_AVG, SRC.C_857_FIRST, SRC.C_858_AVG
	, SRC.C_859_AVG, SRC.C_964_FIRST, SRC.C_965_AVG, SRC.C_966_AVG, SRC.C_969_AVG, GETDATE()
FROM FDS.DBO.TMP_DAILY_CONFIG_AGGREGATE_ALL SRC
	LEFT OUTER JOIN FDS.DW.FDS_DAILY_CONFIG_AGGREGATE_FTBL TRG
		ON TRG.SERIAL_NUMBER = SRC.SERIAL_NUMBER 
			AND TRG.DATECODE = SRC.DATECODE
WHERE TRG.SERIAL_NUMBER IS NULL;

COMMIT TRANSACTION T1;
*/
DECLARE @T_MERGE DATETIME = GETDATE() 

SELECT @T0, @T1MR, @T1, @T2, @T3, @T4, @T5, @TC
--, @T_MERGE

SELECT CHANGE, COUNT(*) CNT
FROM @SUMMARYOFCHANGES
GROUP BY CHANGE

--TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_MR
--TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C01
--TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C02
--TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C03
--TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C04
--TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_C05
--TRUNCATE TABLE FDS.dbo.tmp_DAILY_CONFIG_AGGREGATE_ALL

/*
CHANGE	CNT
INSERT	9425
UPDATE	9479
-- from profiler
MERGE
CPU	Reads	Writes	Duration
6719	373064	459	8432

UPSERT
CPU	Reads	Writes	Duration
17140	558958	10516	29174

-- for tempdb usage
select session_id, user_objects_alloc_page_count, internal_objects_alloc_page_count 
from sys.dm_db_session_space_usage
where user_objects_alloc_page_count + internal_objects_alloc_page_count > 0
*/
